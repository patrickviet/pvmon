


var rs = require('rolling_state.js');

// we always send an event to rolling state
var streams = {
	'rolling_state': rs,
};


module.exports.process = function(req,res,body) {
			
	// FIXME: add some more type checks
	var events = JSON.parse(body);
	events.forEach(function(ev) {
		if(!ev.hasOwnProperty('stream')) {
			ev.stream = 'rolling_state';
		}

		var stream_list = ev.stream.split(',');
		if(stream_list.length) {


			// a bit of split / stream processing...
			
			var stream_list_unique = {};

			stream_list.forEach(function(st) {
				if(streams.hasOwnProperty(st)) {
					// all good
					stream_list_unique[st] = 1;
				} else {
					// we have an error here!!
					// for now we just go to default...
					stream_list_unique['rolling_state'] = 1;
				}


				ev.stream = [];
				for (var key in stream_list_unique) {
					ev.stream.push(key);
				}
			});


		} else {
			ev.stream = ['rolling_state'];
		}
		
		// execute for all streams
		ev.stream.forEach(function(st) { streams[st].insert_event(ev); });

	});

	res.writeHead(200, {'Content-Type':'text/plain'});
	res.write("OK\n");
	res.end();
};

