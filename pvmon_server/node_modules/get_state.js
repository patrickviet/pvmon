
var rs = require('rolling_state.js');


module.exports.get_state = function(req,res,body) {
			
	// FIXME: add some more type checks
	var req;
	try {
		req = JSON.parse(body);
	}
	catch(e) {
		console.log('error: '+e);
		res.write('parse err '+e);
		res.writeHead(500, {'Content-Type':'application/json'});
		res.end();
		return;

	}

	// Possible criteron: 


	res.writeHead(200, {'Content-Type':'application/json'});
	

	// check syntax of req
	try {
		var count = 0;
		(['host','service']).forEach(function(k) {
			if(req.hasOwnProperty(k)) {
				if(!Array.isArray(req[k])) { throw('param '+k+' must be an array'); }
				if(req[k].length) { count++; }
				req[k].forEach(function(p) {
					if(typeof(p) != 'string') { throw('all elements of param '+k+' must be strings'); }
					
					if(p.match(/[^A-Za-z0-9\/\.\-\_]/)) { throw('match for param of k ('+p+') must not match anything but /[^A-Za-z0-9\/\.\-\_]/'); }
				});
			} else {
				req[k] = [];
			}
		});

		//if(!count) { throw('need to specify service and/or host list'); }
	}
	catch(e) {
		console.log('error: '+e);
		res.write('param err '+e);
		res.end();
		return;
	}

	st = rs.get_state(req.host,req.service);
	console.log(st);

	res.write(JSON.stringify(st,null,"  "));


	res.end();
};

